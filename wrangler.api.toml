name = "msgstats-api"
compatibility_date = "2026-01-01"
compatibility_flags = ["nodejs_compat"]
main = "workers/api/worker.ts"

[vars]
META_REDIRECT_URI = "https://msgstats.from-trees.com/api/auth/callback"
META_SCOPES = "pages_show_list,pages_messaging,pages_read_engagement,pages_manage_metadata,business_management,instagram_basic,instagram_manage_messages"

[[d1_databases]]
binding = "DB"
database_name = "msgstats-db"
database_id = "b1918df0-760c-41f1-9778-9d5f95ab9a41"

[[durable_objects.bindings]]
name = "SYNC_RUNS_HUB"
class_name = "SyncRunsHub"
script_name = "msgstats-web"

[[durable_objects.bindings]]
name = "INBOX_HUB"
class_name = "InboxHub"
script_name = "msgstats-web"

[[durable_objects.bindings]]
name = "SYNC_SCOPE_ORCHESTRATOR"
class_name = "SyncScopeOrchestrator"

[[migrations]]
tag = "v1"
new_classes = ["SyncScopeOrchestrator"]

[[analytics_engine_datasets]]
binding = "AE_META_CALLS"
dataset = "AE_META_CALLS"

[[analytics_engine_datasets]]
binding = "AE_APP_ERRORS"
dataset = "AE_APP_ERRORS"

[queues]

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "msgstats-sync"

[[queues.consumers]]
queue = "msgstats-sync"
max_batch_size = 1
[observability]
[observability.logs]
enabled = true
invocation_logs = true

[triggers]
crons = ["*/5 * * * *"]

[ai]
binding = "AI"


[env.staging]
name = "msgstats-api-staging"

[env.staging.vars]
META_REDIRECT_URI = "https://staging.msgstats.from-trees.com/api/auth/callback"
META_SCOPES = "pages_show_list,pages_messaging,pages_read_engagement,pages_manage_metadata,business_management,instagram_basic,instagram_manage_messages"
CLOUDFLARE_ACCOUNT_ID = "125d8016e23830dcaf86de127ce90576"

[[env.staging.analytics_engine_datasets]]
binding = "AE_META_CALLS"
dataset = "AE_META_CALLS"

[[env.staging.analytics_engine_datasets]]
binding = "AE_APP_ERRORS"
dataset = "AE_APP_ERRORS"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "msgstats-db-staging"
database_id = "54853690-cef8-4a81-9908-0dcdb9ad5910"

[[env.staging.durable_objects.bindings]]
name = "SYNC_RUNS_HUB"
class_name = "SyncRunsHub"
script_name = "msgstats-web-staging"

[[env.staging.durable_objects.bindings]]
name = "INBOX_HUB"
class_name = "InboxHub"
script_name = "msgstats-web-staging"

[[env.staging.durable_objects.bindings]]
name = "SYNC_SCOPE_ORCHESTRATOR"
class_name = "SyncScopeOrchestrator"

[[env.staging.migrations]]
tag = "v1"
new_classes = ["SyncScopeOrchestrator"]

[[env.staging.queues.producers]]
binding = "SYNC_QUEUE"
queue = "msgstats-sync-staging"

[[env.staging.queues.consumers]]
queue = "msgstats-sync-staging"
max_batch_size = 1

[env.staging.observability]
[env.staging.observability.logs]
enabled = true
invocation_logs = true

[env.staging.triggers]
crons = ["0 * * * *"]

[env.staging.ai]
binding = "AI"

[env.production]
name = "msgstats-api"

[env.production.vars]
META_REDIRECT_URI = "https://msgstats.from-trees.com/api/auth/callback"
META_SCOPES = "pages_show_list,pages_messaging,pages_read_engagement,pages_manage_metadata,business_management,instagram_basic,instagram_manage_messages"
CLOUDFLARE_ACCOUNT_ID = "125d8016e23830dcaf86de127ce90576"

[[env.production.analytics_engine_datasets]]
binding = "AE_META_CALLS"
dataset = "AE_META_CALLS"

[[env.production.analytics_engine_datasets]]
binding = "AE_APP_ERRORS"
dataset = "AE_APP_ERRORS"

[[env.production.d1_databases]]
binding = "DB"
database_name = "msgstats-db"
database_id = "b1918df0-760c-41f1-9778-9d5f95ab9a41"

[[env.production.durable_objects.bindings]]
name = "SYNC_RUNS_HUB"
class_name = "SyncRunsHub"
script_name = "msgstats-web"

[[env.production.durable_objects.bindings]]
name = "INBOX_HUB"
class_name = "InboxHub"
script_name = "msgstats-web"

[[env.production.durable_objects.bindings]]
name = "SYNC_SCOPE_ORCHESTRATOR"
class_name = "SyncScopeOrchestrator"

[[env.production.migrations]]
tag = "v1"
new_classes = ["SyncScopeOrchestrator"]

[[env.production.queues.producers]]
binding = "SYNC_QUEUE"
queue = "msgstats-sync"

[[env.production.queues.consumers]]
queue = "msgstats-sync"
max_batch_size = 1

[env.production.observability]
[env.production.observability.logs]
enabled = true
invocation_logs = true

[env.production.triggers]
crons = ["0 * * * *"]

[env.production.ai]
binding = "AI"
